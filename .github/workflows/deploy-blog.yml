name: ðŸš€ Deploy Blog

# Deploys the blog site to GitHub Pages
# Only builds static HTML from existing content (no AI generation)
# Schedule: Daily at 4:00 AM UTC

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:
  workflow_run:
    workflows: ["ðŸ¤– Content Pipeline"]
    types: [completed]

jobs:
  deploy:
    name: ðŸ“¦ Build & Deploy
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'schedule' || 
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm

      - name: Build static site
        run: node script/generate-blog.js --html-only
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}

      - uses: ./.github/actions/deploy-pages
        with:
          source-dir: blog-output
          repo: openstackdaily/openstackdaily.github.io
          branch: main
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'Deploy: $(date -u +"%Y-%m-%d %H:%M UTC")'
          preserve-cname: 'true'

      - name: Summary
        run: |
          echo "## ðŸš€ Blog Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://openstackdaily.github.io" >> $GITHUB_STEP_SUMMARY
          echo "**Articles:** $(find blog-output/posts -type f -name 'index.html' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
