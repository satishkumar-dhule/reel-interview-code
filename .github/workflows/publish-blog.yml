name: ðŸ“ Publish Blog

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 02:00 UTC
  workflow_dispatch:
    inputs:
      use_ai:
        description: 'Use AI to transform content'
        required: false
        type: boolean
        default: true

jobs:
  publish-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install dotenv @libsql/client

      - name: Install OpenCode CLI
        run: npm install -g opencode-ai

      - name: Generate blog
        run: node script/generate-blog.js
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          USE_AI_TRANSFORM: ${{ inputs.use_ai || 'true' }}

      - name: Deploy to blog repository
        env:
          DEPLOY_REPO: openstackdaily/openstackdaily.github.io
          DEPLOY_BRANCH: main
          GIT_USER_NAME: ${{ github.actor }}
          GIT_USER_EMAIL: ${{ github.actor }}@users.noreply.github.com
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name "$GIT_USER_NAME"
          git config --global user.email "$GIT_USER_EMAIL"
          
          # Clone blog repo
          git clone --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${DEPLOY_REPO}.git" blog-deploy
          
          # Clear old files (except .git)
          cd blog-deploy
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          cd ..
          
          # Copy new build
          cp -r blog-output/* blog-deploy/
          
          # Commit and push
          cd blog-deploy
          git add -A
          git diff --staged --quiet || git commit -m "Update blog: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin ${DEPLOY_BRANCH}

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“ Blog Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Blog URL:** https://openstackdaily.github.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "blog-output" ]; then
            echo "### Generated Content" >> $GITHUB_STEP_SUMMARY
            echo "- Index page" >> $GITHUB_STEP_SUMMARY
            echo "- Category pages" >> $GITHUB_STEP_SUMMARY
            echo "- $(find blog-output/posts -type f -name 'index.html' 2>/dev/null | wc -l) article pages" >> $GITHUB_STEP_SUMMARY
          fi
