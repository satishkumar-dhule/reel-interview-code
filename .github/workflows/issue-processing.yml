name: ðŸ”„ Issue Processing

# Unified issue processing workflow
# Combines: issue-processor.yml + cross-repo-issue-sync.yml
# Handles: Local issues + external repo issues

on:
  issues:
    types: [opened, labeled]
  
  schedule:
    # Every 15 minutes: Check for external issues
    - cron: '*/15 * * * *'
    # Every 30 minutes: Process local issues and cleanup stale
    - cron: '*/30 * * * *'
  
  workflow_dispatch:
    inputs:
      source:
        description: 'Issue source'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - external
          - both
      source_repo:
        description: 'External source repository (owner/repo)'
        required: false
        default: 'open-interview/open-interview.github.io'
      max_issues:
        description: 'Maximum issues to process'
        required: false
        default: '10'
      force_reprocess:
        description: 'Force reprocess completed issues'
        required: false
        default: 'false'
        type: boolean

env:
  SOURCE_REPO: ${{ inputs.source_repo || 'open-interview/open-interview.github.io' }}

jobs:
  check-trigger:
    name: ðŸ” Check Trigger
    runs-on: ubuntu-latest
    outputs:
      should_process_local: ${{ steps.check.outputs.should_process_local }}
      should_process_external: ${{ steps.check.outputs.should_process_external }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Determine what to process
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { eventName, payload } = context;
            
            // For issue events, check if it has the bot:processor label
            if (eventName === 'issues') {
              const issue = payload.issue;
              const labels = issue.labels.map(l => l.name);
              
              if (labels.includes('bot:in-progress') || 
                  (labels.includes('bot:completed') && !${{ inputs.force_reprocess || false }})) {
                core.setOutput('should_process_local', 'false');
                core.setOutput('should_process_external', 'false');
                return;
              }
              
              if (labels.includes('bot:processor')) {
                core.setOutput('should_process_local', 'true');
                core.setOutput('should_process_external', 'false');
                core.setOutput('issue_number', issue.number.toString());
                return;
              }
              
              core.setOutput('should_process_local', 'false');
              core.setOutput('should_process_external', 'false');
              return;
            }
            
            // For schedule/manual triggers
            const source = '${{ inputs.source || 'both' }}';
            const isExternalSchedule = context.payload.schedule === '*/15 * * * *';
            const isLocalSchedule = context.payload.schedule === '*/30 * * * *';
            
            if (source === 'both' || isExternalSchedule || source === 'external') {
              core.setOutput('should_process_external', 'true');
            } else {
              core.setOutput('should_process_external', 'false');
            }
            
            if (source === 'both' || isLocalSchedule || source === 'local') {
              core.setOutput('should_process_local', 'true');
            } else {
              core.setOutput('should_process_local', 'false');
            }
            
            core.setOutput('issue_number', '');

  process-local:
    name: âš™ï¸ Process Local Issues
    needs: check-trigger
    if: needs.check-trigger.outputs.should_process_local == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      
      - name: Add in-progress label
        if: needs.check-trigger.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ needs.check-trigger.outputs.issue_number }}');
            if (issueNumber) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['bot:in-progress']
              });
            }
      
      - name: Run Processor Bot
        id: processor
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          MAX_ISSUES: ${{ inputs.max_issues || '10' }}
          SINGLE_ISSUE: ${{ needs.check-trigger.outputs.issue_number }}
        run: node script/bots/processor-bot.js
      
      - name: Sync to Vector DB
        if: success()
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: node script/sync-vector-db.js --mode=incremental || true

  process-external:
    name: ðŸ”— Process External Issues
    needs: check-trigger
    if: needs.check-trigger.outputs.should_process_external == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      
      - name: Fetch external issues
        id: fetch
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const sourceRepo = process.env.SOURCE_REPO;
            const [sourceOwner, sourceRepoName] = sourceRepo.split('/');
            const maxIssues = parseInt('${{ inputs.max_issues || '10' }}');
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: sourceOwner,
              repo: sourceRepoName,
              labels: 'bot:processor',
              state: 'open',
              per_page: maxIssues,
              sort: 'created',
              direction: 'desc'
            });
            
            const toProcess = issues.filter(issue => {
              const labels = issue.labels.map(l => l.name);
              return !labels.includes('bot:in-progress') && !labels.includes('bot:completed');
            });
            
            const processed = [];
            for (const issue of toProcess) {
              await github.rest.issues.addLabels({
                owner: sourceOwner,
                repo: sourceRepoName,
                issue_number: issue.number,
                labels: ['bot:in-progress']
              });
              
              processed.push({
                number: issue.number,
                title: issue.title,
                body: issue.body,
                url: issue.html_url
              });
            }
            
            const fs = require('fs');
            fs.writeFileSync('/tmp/external-issues.json', JSON.stringify(processed, null, 2));
            
            core.setOutput('processed_count', processed.length.toString());
            core.setOutput('issues', JSON.stringify(processed));

      - name: Process external issues
        if: steps.fetch.outputs.processed_count != '0'
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          EXTERNAL_ISSUES_FILE: /tmp/external-issues.json
        run: node script/bots/processor-bot.js --external-issues

      - name: Update external issues
        if: always() && steps.fetch.outputs.processed_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const sourceRepo = process.env.SOURCE_REPO;
            const [sourceOwner, sourceRepoName] = sourceRepo.split('/');
            const issues = JSON.parse('${{ steps.fetch.outputs.issues }}');
            
            for (const issue of issues) {
              try {
                await github.rest.issues.removeLabel({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  name: 'bot:in-progress'
                }).catch(() => {});
                
                await github.rest.issues.addLabels({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  labels: ['bot:completed']
                });
                
                await github.rest.issues.createComment({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  body: 'âœ… **Processing Complete**\n\nProcessed by main repository.'
                });
                
                await github.rest.issues.update({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  state: 'closed'
                });
              } catch (error) {
                console.log(`Error updating issue #${issue.number}: ${error.message}`);
              }
            }

  cleanup-stale:
    name: ðŸ§¹ Cleanup Stale
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/30 * * * *'
    steps:
      - name: Remove stale in-progress labels
        uses: actions/github-script@v7
        with:
          script: |
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'bot:in-progress',
              state: 'open',
              per_page: 50
            });
            
            for (const issue of issues.data) {
              const updatedAt = new Date(issue.updated_at);
              
              if (updatedAt < oneHourAgo) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'bot:in-progress'
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'âš ï¸ **Processing Reset** - Stuck for over 1 hour, label removed for reprocessing.'
                });
              }
            }

  summary:
    name: ðŸ“‹ Summary
    needs: [check-trigger, process-local, process-external, cleanup-stale]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”„ Issue Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Local Issues | ${{ needs.process-local.result == 'success' && 'âœ…' || needs.process-local.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— External Issues | ${{ needs.process-external.result == 'success' && 'âœ…' || needs.process-external.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§¹ Cleanup | ${{ needs.cleanup-stale.result == 'success' && 'âœ…' || needs.cleanup-stale.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
