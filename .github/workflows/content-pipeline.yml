name: ðŸ¤– Content Pipeline

# Unified content generation pipeline
# Runs: Creator â†’ Verifier â†’ Processor â†’ Blog Generator
# Schedule: Daily at 2:00 AM UTC

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Which stage to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - creator
          - verifier
          - processor
          - blog-generator
      count:
        description: 'Number of items to process'
        required: false
        default: '5'

jobs:
  creator:
    name: ðŸ“ Creator Bot
    if: github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'creator'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Creator Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          COUNT: ${{ inputs.count || '5' }}
        run: node script/bots/creator-bot.js

  verifier:
    name: âœ… Verifier Bot
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'verifier')
    needs: [creator]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Verifier Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          MODE: scan
          LIMIT: ${{ inputs.count || '10' }}
        run: node script/bots/verifier-bot.js

  processor:
    name: âš™ï¸ Processor Bot
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'processor')
    needs: [verifier]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Processor Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          MAX_ITEMS: ${{ inputs.count || '10' }}
        run: node script/bots/processor-bot.js

  blog-generator:
    name: ðŸ“° Blog Generator
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'blog-generator')
    needs: [processor]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Generate Blog Content
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: node script/generate-blog.js

  update-monitor:
    name: ðŸ“Š Update Monitor
    needs: [blog-generator]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - name: Generate monitor data
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: node script/fetch-bot-monitor-data.js
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -f client/public/data/bot-monitor.json
          git diff --staged --quiet || git commit -m "Update bot monitor data [skip ci]"
          git push

  summary:
    name: ðŸ“‹ Summary
    needs: [creator, verifier, processor, blog-generator, update-monitor]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ¤– Content Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Creator | ${{ needs.creator.result == 'success' && 'âœ…' || needs.creator.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Verifier | ${{ needs.verifier.result == 'success' && 'âœ…' || needs.verifier.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Processor | ${{ needs.processor.result == 'success' && 'âœ…' || needs.processor.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“° Blog Generator | ${{ needs.blog-generator.result == 'success' && 'âœ…' || needs.blog-generator.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Monitor | ${{ needs.update-monitor.result == 'success' && 'âœ…' || needs.update-monitor.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
