name: ðŸ§ª Manual E2E Tests

# Run E2E tests manually with custom options

on:
  workflow_dispatch:
    inputs:
      pattern:
        description: 'Test file or grep pattern (e.g., "e2e/home.spec.ts" or "search")'
        required: true
        type: string
      browser:
        description: 'Browser to test'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      retries:
        description: 'Number of retries'
        required: false
        default: '2'
        type: string

jobs:
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm

      - name: Fetch test data
        run: node script/fetch-questions-for-build.js
        env:
          TURSO_DATABASE_URL_RO: ${{ secrets.TURSO_DATABASE_URL_RO }}
          TURSO_AUTH_TOKEN_RO: ${{ secrets.TURSO_AUTH_TOKEN_RO }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

      - name: Install Playwright
        run: |
          if [ "${{ inputs.browser }}" = "all" ]; then
            pnpm exec playwright install --with-deps
          else
            pnpm exec playwright install --with-deps ${{ inputs.browser }}
          fi

      - name: Build application
        run: pnpm run build && pnpm run build:pagefind

      - name: Run tests
        run: |
          BROWSER_FLAG=""
          if [ "${{ inputs.browser }}" != "all" ]; then
            BROWSER_FLAG="--project=${{ inputs.browser }}"
          fi
          
          if [[ "${{ inputs.pattern }}" == *".spec.ts"* ]] || [[ "${{ inputs.pattern }}" == *"e2e/"* ]]; then
            pnpm exec playwright test "${{ inputs.pattern }}" $BROWSER_FLAG --retries=${{ inputs.retries }}
          else
            pnpm exec playwright test --grep "${{ inputs.pattern }}" $BROWSER_FLAG --retries=${{ inputs.retries }}
          fi
        env:
          CI: 'true'

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pattern:** \`${{ inputs.pattern }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "**Retries:** ${{ inputs.retries }}" >> $GITHUB_STEP_SUMMARY
