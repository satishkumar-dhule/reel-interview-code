name: ðŸš€ Deploy App

# Deploys the main interview app to GitHub Pages
# Triggers: On push to main, or manual dispatch

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/workflows/content-pipeline.yml'
      - '.github/workflows/deploy-blog.yml'
      - '.github/workflows/social-analytics.yml'
  workflow_dispatch:

concurrency:
  group: deploy-app-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm

      - name: Fetch data from Turso
        run: |
          node script/fetch-questions-for-build.js
          node script/fetch-question-history.js
          node script/fetch-bot-monitor-data.js
        env:
          TURSO_DATABASE_URL_RO: ${{ secrets.TURSO_DATABASE_URL_RO }}
          TURSO_AUTH_TOKEN_RO: ${{ secrets.TURSO_AUTH_TOKEN_RO }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Build application
        run: |
          pnpm run build
          pnpm run build:pagefind

      - name: Run E2E tests
        run: |
          # Run only core smoke tests in CI
          pnpm exec playwright test e2e/core.spec.ts --project=chromium-desktop
        env:
          CI: 'true'

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 3

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/public
          retention-days: 1

  staging:
    name: ðŸ§ª Deploy Staging
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://stage-open-interview.github.io
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: ./.github/actions/deploy-pages
        with:
          source-dir: dist
          repo: stage-open-interview/stage-open-interview.github.io
          branch: main
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'Deploy: ${{ github.sha }}'
          preserve-cname: 'false'

  production:
    name: ðŸŒ Deploy Production
    needs: staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://open-interview.github.io
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          install: 'false'

      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: ./.github/actions/deploy-pages
        with:
          source-dir: dist
          repo: open-interview/open-interview.github.io
          branch: gh-pages
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'Deploy: ${{ github.sha }}'
          preserve-cname: 'true'

      - name: Ping search engines
        run: node script/ping-search-engines.js
        continue-on-error: true

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | https://stage-open-interview.github.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | https://open-interview.github.io |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
