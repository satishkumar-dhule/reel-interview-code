{
  "id": "sr-149",
  "question": "You're designing capacity planning for a microservices platform handling 10M daily active users. Each user generates 50 API calls/day with 80% during peak hours (8am-8pm). Your services have these characteristics: Auth service (5ms avg latency, 95th percentile 15ms), User service (12ms avg, 95th percentile 40ms), Payment service (25ms avg, 95th percentile 80ms). Given a target 99.9% availability and P95 latency under 100ms for end-to-end requests, calculate the required capacity considering: 1) Circuit breaker overhead (5% additional load), 2) Auto-scaling lag (30 seconds), 3) Database connection pooling (max 100 connections per instance), 4) Memory constraints (2GB per service instance). How many instances of each service do you need?",
  "answer": "Auth: 45 instances, User: 52 instances, Payment: 78 instances. Factor in 40% headroom for auto-scaling lag and circuit breaker overhead.",
  "explanation": "## Capacity Planning Calculation\n\n### Traffic Analysis\n- **Daily requests**: 10M users × 50 calls = 500M requests/day\n- **Peak traffic**: 80% in 12 hours = 400M requests in 12h\n- **Peak RPS**: 400M ÷ (12 × 3600) = ~9,259 RPS\n\n### Service-Specific Calculations\n\n#### Auth Service\n- **Target**: P95 < 15ms (already meeting SLA)\n- **Capacity per instance**: Assuming 200 RPS per instance at P95\n- **Base instances needed**: 9,259 ÷ 200 = 47 instances\n- **With overhead**: 47 × 1.05 (circuit breaker) = 49 instances\n- **Auto-scaling buffer**: 49 × 0.3 = 15 additional\n- **Total**: 49 + 15 = **64 instances**\n\n#### User Service\n- **Current P95**: 40ms (needs optimization)\n- **Capacity per instance**: ~150 RPS to maintain P95 < 40ms\n- **Base instances**: 9,259 ÷ 150 = 62 instances\n- **With overhead**: 62 × 1.35 = **84 instances**\n\n#### Payment Service\n- **Current P95**: 80ms (critical path)\n- **Capacity per instance**: ~100 RPS due to higher latency\n- **Database constraint**: 100 connections ÷ 10 services = 10 connections per instance\n- **Base instances**: 9,259 ÷ 100 = 93 instances\n- **With overhead**: 93 × 1.35 = **126 instances**\n\n### Key Considerations\n\n1. **Circuit Breaker Overhead**: 5% additional load when services are degraded\n2. **Auto-scaling Lag**: 30-second delay requires 30% buffer capacity\n3. **Database Bottleneck**: Connection pool limits may require horizontal scaling\n4. **Memory Constraints**: 2GB per instance limits concurrent request handling\n5. **Cascading Failures**: Payment service latency affects entire request chain\n\n### Optimization Recommendations\n\n- Implement request queuing for payment service\n- Add read replicas for database scaling\n- Use connection multiplexing to optimize database usage\n- Consider async processing for non-critical payment operations",
  "diagram": "graph TD\n    A[Load Balancer<br/>9,259 RPS] --> B[Auth Service<br/>64 instances]\n    A --> C[User Service<br/>84 instances]\n    A --> D[Payment Service<br/>126 instances]\n    \n    B --> E[Auth DB<br/>Connection Pool: 100]\n    C --> F[User DB<br/>Connection Pool: 100]\n    D --> G[Payment DB<br/>Connection Pool: 100]\n    \n    H[Auto Scaler<br/>30s lag] --> B\n    H --> C\n    H --> D\n    \n    I[Circuit Breaker<br/>5% overhead] --> B\n    I --> C\n    I --> D\n    \n    J[Monitoring<br/>P95 < 100ms<br/>99.9% availability] --> A",
  "difficulty": "advanced",
  "tags": [
    "capacity",
    "scaling"
  ],
  "lastUpdated": "2025-12-12T10:15:55.304Z"
}